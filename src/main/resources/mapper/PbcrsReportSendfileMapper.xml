<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hkbank.pbcrs.mapper.PbcrsReportSendfileMapper">
  <resultMap id="BaseResultMap" type="com.hkbank.pbcrs.model.PbcrsReportSendfile">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    <id column="SEQNO" jdbcType="INTEGER" property="seqno" />
    <result column="FILENAME" jdbcType="VARCHAR" property="filename" />
    <result column="FILEPATH" jdbcType="VARCHAR" property="filepath" />
    <result column="TXTFILENAME" jdbcType="VARCHAR" property="txtfilename" />
    <result column="ENCFILENAME" jdbcType="VARCHAR" property="encfilename" />
    <result column="BADFILENAME" jdbcType="VARCHAR" property="badFileName" />
    
    <result column="CREATEDATE" jdbcType="TIMESTAMP" property="createDate" />
  </resultMap>
  
  <resultMap id="ErrorInfo" type="com.hkbank.pbcrs.model.ErrorInfo">
    <id column="SEQNO" jdbcType="INTEGER" property="seqno" />
    <result column="SEQNOFILE" jdbcType="VARCHAR" property="seqnofile" />
    <result column="ERRINFSEQNO" jdbcType="VARCHAR" property="errinfseqno" />
    <result column="REPORTSEQNO" jdbcType="VARCHAR" property="reportseqno" />
    <result column="NAME" jdbcType="VARCHAR" property="name" />
    <result column="IDNUM" jdbcType="VARCHAR" property="idnum" />
    <result column="FBCODE" jdbcType="VARCHAR" property="fbcode" />
    <result column="FBMSG" jdbcType="VARCHAR" property="fbmsg" />
    <result column="MSG_INFO" jdbcType="VARCHAR" property="msgInfo" />
    <result column="STATE" jdbcType="TIMESTAMP" property="state" />
    <result column="INFRECTYPE" jdbcType="TIMESTAMP" property="infrecType" />
    <result column="RPTDATE" jdbcType="TIMESTAMP" property="rptDate" />
    <result column="CUSTCODE" jdbcType="TIMESTAMP" property="custNo" />
    <result column="ISFILTER" jdbcType="TIMESTAMP" property="isFilter" />
    <result column="FILTERSEQNO" jdbcType="TIMESTAMP" property="filterSeqno" />
    <collection property="children" ofType="com.hkbank.pbcrs.model.ErrorInfo">
    	<id column="ERRINFSEQNO1" property="errinfseqno"/>
    	<result column="FBCODE1" property="fbcode"/>
    	<result column="FBMSG1" property="fbmsg"/>
    	<result column="MSG_INFO1" property="msgInfo"/>
    	<result column="FBCODE1" property="fbcode"/>
    </collection>
  </resultMap>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Short">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    delete from PBCRS_REPORT_SENDFILE
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.hkbank.pbcrs.model.PbcrsReportSendfile">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    insert into PBCRS_REPORT_SENDFILE (SEQNO, FILENAME, FILEPATH, 
      TXTFILENAME, ENCFILENAME, CREATEDATE
      )
    values (#{seqno,jdbcType=INTEGER}, #{filename,jdbcType=VARCHAR}, #{filepath,jdbcType=VARCHAR}, 
      #{txtfilename,jdbcType=VARCHAR}, #{encfilename,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.hkbank.pbcrs.model.PbcrsReportSendfile">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    update PBCRS_REPORT_SENDFILE
    set FILENAME = #{filename,jdbcType=VARCHAR},
      FILEPATH = #{filepath,jdbcType=VARCHAR},
      TXTFILENAME = #{txtfilename,jdbcType=VARCHAR},
      ENCFILENAME = #{encfilename,jdbcType=VARCHAR},
       
      CREATEDATE = #{createDate,jdbcType=TIMESTAMP}
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </update>
  
    <update id="update" parameterType="com.hkbank.pbcrs.model.PbcrsReportSendfile">

    update PBCRS_REPORT_SENDFILE
    set
      ENCFILENAME = #{encfilename,jdbcType=VARCHAR},
      BADFILENAME = #{badFileName,jdbcType=VARCHAR}
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </update>
  
  <select id="selectByPrimaryKey" parameterType="java.lang.Short" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    select SEQNO, FILENAME, FILEPATH, TXTFILENAME, ENCFILENAME, CREATEDATE
    from PBCRS_REPORT_SENDFILE
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    select SEQNO, FILENAME, FILEPATH, TXTFILENAME, ENCFILENAME, CREATEDATE
    from PBCRS_REPORT_SENDFILE
  </select>
  <select id="getSeqnoByNameDate" resultType="int" parameterType="Map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    select count(1) from PBCRS_REPORT_SENDFILE 
    where createdate=to_date('${etldate}','yyyyMMdd') and txtfilename like '${filename}%'
  </select>
  
  <select id="getKey" resultType="int">
  	select SEQ_REPORT_SENDFILE.NEXTVAL from dual
  </select>
  
  
     <sql id="sql_selectCont">
		
  	 <if test="queryTxtFileName !=null and queryTxtFileName !=''">
    	and TXTFILENAME like '%${queryTxtFileName}%'
    </if> 
    <if test="queryFilepath !=null and queryFilepath !=''">
    	and FILEPATH like '%${queryFilepath}%'
    </if> 
    <if test="queryRptDate!=null and queryRptDate!=''">
    	and to_char(CREATEDATE,'yyyy-mm-dd') = #{queryRptDate}
    </if>
     <if test="RptDate!=null and RptDate!=''">
    	and txtfilename like '%${RptDate}%'
    </if>
    <if test="conditionId !=null and conditionId !=''">
    	and CONDITIONID in( ${conditionId})
    </if>
   <if test="queryRptType !=null and queryRptType !=''">
    	and substr(substr(txtfilename,length(txtfilename)-33,34),23,3) = #{queryRptType}
    </if> 
    
    <if test="querySysType !=null and querySysType !='' ">
       and  sysId=#{querySysType}
    </if>
    <!--<if test="querySysType !=null and querySysType !='' and querySysType == 'IND'">
    	and (substr(substr(txtfilename,length(txtfilename)-33,34),23,3) 
    	IN (SELECT reportId from pbcrs_sys_reportconfig where to_number(reportId) &lt; 310) or sysId='IND')
    </if>-->
		
	</sql>
	
    <select id="selectListCount" resultType="int" parameterType="map">
SELECT count(1) from PBCRS_REPORT_SENDFILE
 where 1=1
<include refid="sql_selectCont"></include>
  </select>
   
   
   <select id="selectListPage" resultType="map" parameterType="map">
       select SEQNO,
              FILENAME,
              FILEPATH,
              TXTFILENAME,
              ENCFILENAME,
              CREATEDATE,
              BADFILENAME,
              TXTNAME,
              BADNAME,
              REPORTNAME,
              isbatch,
              CREATETIME,
              INFOCOUNT,
              ISUPLOAD,
              case when (rn = '1' and isbatch = 'Y') or ( isbatch !='Y') then '最新' else '' end tab,
              sysId SYSID
       from(  select r.*,row_number() over(partition by CREATEDATE, REPORTNAME,isbatch order by SEQNO desc) rn
              from (select SEQNO,
                           FILENAME,
                           FILEPATH,
                           TXTFILENAME,
                           nvl(ENCFILENAME,null)ENCFILENAME,
                           to_char(CREATEDATE,'yyyy-mm-dd') CREATEDATE,
                           nvl(BADFILENAME,null) BADFILENAME,
                           substr(txtfilename,length(txtfilename)-33,34) TXTNAME,
                           nvl(substr(badfilename,length(badfilename)-33,34),null) BADNAME,
                           (select REPORTNAME from pbcrs_sys_reportconfig where reportId  = substr(substr(txtfilename,length(txtfilename)-33,34),23,3)) REPORTNAME ,
                           sysId SYSID,
                           t.isbatch,
                           INFOCOUNT,
                           ISUPLOAD,
                           CREATETIME
                    from  PBCRS_REPORT_SENDFILE t
                    where 1=1
                    <include refid="sql_selectCont"></include>
                   )  r
           ) where rn between ${startindex}+1 and ${endindex}
   </select>
  
  
  <!--                            以下为银联数据查询                                                                                -->
<sql id="sql_YLselectCont">
		
  	<if test="YLqueryEncFileName !=null and YLqueryEncFileName !=''">
    	and ENCFILENAME like '%${YLqueryEncFileName}%'
    </if> 
    <if test="YLqueryFilepath !=null and YLqueryFilepath !=''">
    	and FILEPATH like '%${YLqueryFilepath}%'
    </if> 
    <if test="YLqueryRptDate and YLqueryRptDate!=''">
    	and to_char(CREATEDATE,'yyyy-mm-dd') = #{YLqueryRptDate}
    </if>
    <if test="YLconditionId !=null and YLconditionId !=''">
    	and CONDITIONID in( ${YLconditionId})
    </if>
   <if test="YLqueryRptType !=null and YLqueryRptType !=''">
    	and substr(substr(txtfilename,length(txtfilename)-33,34),23,3) = #{YLqueryRptType}
   </if> 

		
</sql>
  
  
<select id="selectYLListCount" resultType="int" parameterType="map">
	SELECT count(1) from PBCRS_REPORT_SENDFILE
	 where 1=1 and CONDITIONID ='YL'
	<include refid="sql_YLselectCont"></include>
</select>
   
   
<select id="selectYLListPage" resultType="map" parameterType="map"> 
    select * from (
	    SELECT A.*, ROWNUM RN  from ( 
	    select SEQNO, FILENAME, FILEPATH, TXTFILENAME, nvl(ENCFILENAME,null)ENCFILENAME,
	     to_char(CREATEDATE,'yyyy-mm-dd') CREATEDATE,nvl(BADFILENAME,null)BADFILENAME,
	     substr(txtfilename,length(txtfilename)-33,34) TXTNAME,
	     nvl(substr(badfilename,length(badfilename)-33,34),null) BADNAME,
	     (select REPORTNAME from pbcrs_sys_reportconfig where reportId  = substr(substr(encfilename,length(encfilename)-33,34),23,3)) REPORTNAME,
	     LOADFILETIME
	    from  PBCRS_REPORT_SENDFILE
        where 1 =1 and CONDITIONID ='YL' <include refid="sql_YLselectCont"></include>
        order by CREATEDATE desc,SEQNO desc
		) A
	  	WHERE ROWNUM &lt;=${endindex}
  	) where RN &gt;${startindex}
</select>

  <insert id="insertYL"  parameterType="map">
  		insert into PBCRS_REPORT_SENDFILE(
  			SEQNO,
  			FILENAME,
  			FILEPATH,
  			TXTFILENAME,
  			ENCFILENAME,
  			CREATEDATE,
  			BADFILENAME,
  			CONDITIONID,
  			LOADFILETIME)
		values(
			SEQ_REPORT_SENDFILE.NEXTVAL,
			#{FILENAME},
			#{FILEPATH},
			#{TXTFILENAME},
			#{ENCFILENAME},
			to_date(#{CREATEDATE},'yyyymmdd'),
			#{BADFILENAME},
			#{CONDITIONID},
			#{LOADFILETIME}
		)
  </insert>
  
    <delete id="deleteYL" parameterType="map">
  		delete PBCRS_REPORT_SENDFILE 
  		  where CREATEDATE = to_date(#{CREATEDATE},'yyyymmdd')
  		  and CONDITIONID = #{CONDITIONID}
  </delete>
  
  <sql id="sql_selectSendFileRel">	
  	<if test="rptDate !=null and rptDate != ''">
    	and to_char(to_date(substr(t1.txtfilename, length(t1.txtfilename) - 19, 8),'yyyy-mm-dd'),'yyyy-mm-dd') = #{rptDate}
    </if>
    <if test="name !=null and name != ''">
        and t.name like '%'||#{name}||'%'
    </if>
    <if test="idNum !=null and idNum != ''">
        and t.idnum like '%'||#{idNum}||'%'
    </if>
    <if test="custCode !=null and custCode != ''">
        and t.custcode like '%'||#{custCode}||'%'
    </if>
   	<if test="encName !=null and encName != ''">
        and t1.encfilename like '%'||#{encName}||'%'
    </if>

</sql>
  
   <select id="selectSendFileRelCount" resultType="int" parameterType="map"> 
		select count(1) from PBCRS_REPORT_SENDFILE_REL t
		inner join PBCRS_REPORT_SENDFILE t1 
		on t.fileseqno = t1.seqno 
		where 1=1
		<include refid="sql_selectSendFileRel"></include>
 </select>
  
  <select id="selectSendFileRel" resultType="map" parameterType="map"> 
		select * from (
			select t.*,rownum as rn from (
			    select t.reportseqno,
			           t.orderseqno,
			           t1.encfilename,
			           substr(t1.txtfilename, length(t1.txtfilename) - 11,3) as reportcode,
			           substr(t1.txtfilename, length(t1.txtfilename) - 33) as txtfilename,
			           to_char(to_date(substr(t1.txtfilename, length(t1.txtfilename) - 19, 8),'yyyy-mm-dd'),'yyyy-mm-dd') as rptdate,
			           to_char(t1.createdate, 'yyyy-mm-dd') as createdate,
			           t1.sysid,
                       t.name,
                       t.idnum,
                       t.custcode
			      from PBCRS_REPORT_SENDFILE_REL t
			     inner join PBCRS_REPORT_SENDFILE t1
			        on t.fileseqno = t1.seqno
			     where 1 = 1
                 <include refid="sql_selectSendFileRel"></include>
			 )t  where ROWNUM &lt;=${endindex}
			    
			) where RN &gt;${startindex}
 
 </select>
 
 
    <select id="queryErrorInfoCount" resultType="int" parameterType="map"> 
		 select count(1) from (
				 select r.seqno,s.*, e.* from pbcrs_report_receivefile r
	            inner join PBCRS_REPORT_FBINF f on r.seqno = f.receivefileseqno
	            inner join pbcrs_report_errinf e on f.fbinfseqno = e.fbinfseqno and e.errinfseqno = '1'
	            
	            inner join (
	            select s.seqno seqnofile, s.badfilename,r.REPORTSEQNO,r.name,r.idnum,r.ORDERSEQNO from pbcrs_report_sendfile s
	            inner join pbcrs_report_sendfile_rel r 
	            on s.seqno = r.fileseqno 
	            ) s on  substr(r.receivetxtfilename,length(r.receivetxtfilename)-33) = substr(s.badfilename,length(s.badfilename)-33)
	            and f.errrecid = s.ORDERSEQNO
	            where  s.seqnofile = #{seqNo}
				) t
 </select>
  
  <select id="queryErrorInfo" resultMap="ErrorInfo" parameterType="map"> 
		select p.isFilter,p.filterseqno, p.INFRECTYPE,p.RPTDATE,p.CUSTCODE, 'closed' as state, p.FBINFSEQNO as seqno,p.seqnofile,p.ERRINFSEQNO, p.REPORTSEQNO,p.NAME,p.IDNUM,p.FBCODE,p.FBMSG,p.MSG_INFO,e2.errinfseqno as errinfseqno1,e2.fbcode as fbcode1 ,e2.fbmsg as fbmsg1,e2.msg_info as msg_info1 from (
 			select p.*,rownum as rn from (
 
	            select r.seqno,s.*, e.*,substr(s.badfilename,length(s.badfilename)-11,3) as INFRECTYPE,substr(s.badfilename,length(s.badfilename)-19,8) as RPTDATE,case when i.seqno is not null then 'Y' else 'N'end isFilter ,i.seqno as filterseqno   from pbcrs_report_receivefile r
	            inner join PBCRS_REPORT_FBINF f on r.seqno = f.receivefileseqno
	            inner join pbcrs_report_errinf e on f.fbinfseqno = e.fbinfseqno and e.errinfseqno = '1'
	            
	            inner join (
	            select s.seqno seqnofile, s.badfilename,r.REPORTSEQNO,r.name,r.idnum,r.ORDERSEQNO,r.CUSTCODE from pbcrs_report_sendfile s
	            inner join pbcrs_report_sendfile_rel r 
	            on s.seqno = r.fileseqno 
	            ) s on  substr(r.receivetxtfilename,length(r.receivetxtfilename)-33) = substr(s.badfilename,length(s.badfilename)-33)
	            and f.errrecid = s.ORDERSEQNO
	             left join PBCRS_REPORT_FILTER_DATA i
                 on  i.errinfseqno = f.fbinfseqno and i.fileseqno = s.seqnofile
	            where  s.seqnofile = #{seqNo}
    		)p  where ROWNUM  &lt;=${endindex}
	    ) p 
	   left join pbcrs_report_errinf e2 on e2.fbinfseqno = p.fbinfseqno and e2.errinfseqno != '1'
	
	   where RN &gt;${startindex}

 </select>
 
 
 <insert id="addFilter" >
  		
		insert into PBCRS_REPORT_FILTER_DATA (SEQNO, KEYWORD, NAME, ID, INFRECTYPE, RPTDATE, CREATEDATE, RPT_FLAG, CUST_NO,FILESEQNO, ERRINFSEQNO)
 	values (SEQUENCE_FILTER.Nextval,#{reportseqno},#{name},#{idnum},#{infrecType},#{rptDate},to_char(sysdate,'yyyy-mm-dd'),'0',#{custNo},#{seqnofile},#{seqno})
	 	
  </insert>

    <delete id="removeFilter">
        delete PBCRS_REPORT_FILTER_DATA t
        where t.SEQNO = #{filterSeqno}
    </delete>

    <select id="selectFilterCount" resultType="int">
        select count(1) from PBCRS_REPORT_FILTER_DATA t
        where t.fileseqno = #{seqnofile}
          and t.keyword = #{reportseqno}
    </select>

    <delete id="delete">
        delete from PBCRS_REPORT_FILTER_DATA t
        where t.fileseqno = #{seqnofile}
          and t.keyword = #{reportseqno}
    </delete>

    <update id="updateFilterFlag">
        update ${tableName} t set t.reportFlag = #{reportFlag}
        where ${tableSeqno} = #{seqno} and etl_Date = to_date(#{etlDate},'yyyymmdd')
    </update>
    <update id="updateIsUpload">
        update PBCRS_REPORT_SENDFILE t set t.isupload = 'Y'
        where t.encfilename like #{encName} || '%'
    </update>

</mapper>