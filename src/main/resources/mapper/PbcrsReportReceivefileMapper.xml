<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hkbank.pbcrs.mapper.PbcrsReportReceivefileMapper">
  <resultMap id="BaseResultMap" type="com.hkbank.pbcrs.model.PbcrsReportReceivefile">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    <id column="SEQNO" jdbcType="INTEGER" property="seqno" />
    <result column="RECEIVEFILENAME" jdbcType="VARCHAR" property="receivefilename" />
    <result column="RECEIVEFILEPATH" jdbcType="VARCHAR" property="receivefilepath" />
    <result column="RECEIVETXTFILENAME" jdbcType="VARCHAR" property="receivetxtfilename" />
    <result column="SENDFILENAME" jdbcType="VARCHAR" property="sendfilename" />
    <result column="MSGCODE" jdbcType="VARCHAR" property="msgcode" />
    <result column="SUCCESSCOUNT" jdbcType="INTEGER" property="successCount" />
    <result column="FAILCOUNT" jdbcType="INTEGER" property="failCount" />
    <result column="CREATEDATE" jdbcType="TIMESTAMP" property="createDate" />
    <result column="IMPORTDATE" jdbcType="TIMESTAMP" property="importDate" />
    <result column="REPORTSEQNO" jdbcType="TIMESTAMP" property="reportSeqNo" />
    <result column="REPORTDATE" jdbcType="TIMESTAMP" property="reportDate" />
    <result column="RESULTERRORREASON" jdbcType="VARCHAR" property="resultErrorReason" />
    <result column="VALIDATERESULT" jdbcType="VARCHAR" property="validateResult" />
    <result column="IMPORTTIME" jdbcType="VARCHAR" property="importTime" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Short">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    delete from PBCRS_REPORT_RECEIVEFILE
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.hkbank.pbcrs.model.PbcrsReportReceivefile">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    insert into PBCRS_REPORT_RECEIVEFILE (SEQNO, RECEIVEFILENAME, RECEIVEFILEPATH, 
      RECEIVETXTFILENAME, SENDFILENAME, MSGCODE, 
      SUCCESSCOUNT, FAILCOUNT, CREATEDATE, 
      IMPORTDATE,IMPORTTIME)
    values (#{seqno,jdbcType=INTEGER}, #{receivefilename,jdbcType=VARCHAR}, #{receivefilepath,jdbcType=VARCHAR}, 
      #{receivetxtfilename,jdbcType=VARCHAR}, #{sendfilename,jdbcType=VARCHAR}, #{msgcode,jdbcType=VARCHAR}, 
      #{successCount,jdbcType=INTEGER}, #{failCount,jdbcType=INTEGER}, #{createDate,jdbcType=TIMESTAMP}, 
      #{importDate,jdbcType=TIMESTAMP},#{importTime,jdbcType=TIMESTAMP})
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.hkbank.pbcrs.model.PbcrsReportReceivefile">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    update PBCRS_REPORT_RECEIVEFILE
    set RECEIVEFILENAME = #{receivefilename,jdbcType=VARCHAR},
      RECEIVEFILEPATH = #{receivefilepath,jdbcType=VARCHAR},
      RECEIVETXTFILENAME = #{receivetxtfilename,jdbcType=VARCHAR},
      SENDFILENAME = #{sendfilename,jdbcType=VARCHAR},
      MSGCODE = #{msgcode,jdbcType=VARCHAR},
      SUCCESSCOUNT = #{successCount,jdbcType=INTEGER},
      FAILCOUNT = #{failCount,jdbcType=INTEGER},
      CREATEDATE = #{createDate,jdbcType=TIMESTAMP},
      IMPORTDATE = #{importDate,jdbcType=TIMESTAMP},
      RESULTERRORREASON = #{resultErrorReason,jdbcType=VARCHAR},
      VALIDATERESULT = #{validateResult,jdbcType=VARCHAR}
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Short" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    select SEQNO, RECEIVEFILENAME, RECEIVEFILEPATH, RECEIVETXTFILENAME, SENDFILENAME, 
    MSGCODE, SUCCESSCOUNT, FAILCOUNT, CREATEDATE, IMPORTDATE,RESULTERRORREASON,VALIDATERESULT
    from PBCRS_REPORT_RECEIVEFILE
    where SEQNO = #{seqno,jdbcType=INTEGER}
  </select>
  
  
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    select SEQNO, RECEIVEFILENAME, RECEIVEFILEPATH, RECEIVETXTFILENAME, SENDFILENAME, 
    MSGCODE, SUCCESSCOUNT, FAILCOUNT, CREATEDATE, IMPORTDATE,RESULTERRORREASON,VALIDATERESULT
    from PBCRS_REPORT_RECEIVEFILE
  </select>
  <select id="getKey" resultType="int">
  	select SEQ_REPORT_RECEIVEFILE.NEXTVAL from dual
  </select>
  
  <sql id="sql_selectCont">

    <if test="queryreceiveFileName!=null and queryreceiveFileName!=''">
    	and fbinf.receiveFileName like '%'||#{queryreceiveFileName}||'%'
    </if>
     <if test="querysendFileName!=null and querysendFileName!=''">
    	and sendFileName like '%${querysendFileName}%'
    </if>
    
     <if test="sourceSys !=null and sourceSys !=''">
    	and errinf.sourceSys in (${sourceSys})
    </if>
      <if test="Seqno !=null and Seqno !=''">
    	 and receivefile.seqno= #{Seqno}
    </if>
    
   
  </sql>
  
  <select id="selectPageCount" resultType="int" parameterType="map">
  	
	select 
		count(1)
	 from  pbcrs_report_Fbinf fbinf 
   
    
    left join pbcrs_report_ErrInf errinf
    on errinf.fbinfseqno=fbinf.fbinfseqno
<!--      left join 
    (
    select msgtype,msgcode,msgtab,msgbusscode,to_char(wm_concat(msg)) msgs 
    from pbcrs_report_msg_code 
     group by msgtype,msgcode,msgtab,msgbusscode) msg 
    on 
    errinf.fbcode=msg.msgcode 
    and errinf.fbmsg=msg.msgtab -->
    left join pbcrs_report_receiveFile receivefile
    on fbinf.receivefileseqno=receivefile.seqno <!-- and fbinf.receivefilename=receivefile.receivefilename -->
    left join pbcrs_report_sendfile_rel sendfile
    on  fbinf.errrecid=sendfile.orderseqno
	where 1=1 <!-- instr(msg.msgbusscode,substr(receivefile.receivefilename,23,3))>0 -->
	<include refid="sql_selectCont"></include>
  </select>
  
   <select id="selectPage" resultType="map" parameterType="map">

       select * from (
       select info1.*,ROWNUM RN from (
       select
       errinf.fbcode,
       errinf.fbmsg,
       errinf.msg_info,
       sendfile.seqno,
       sendfile_rel.reportseqno,
       substr(fbinf.receivefilename,23,3) busstype,
       sendfile_rel.name
       from  pbcrs_report_Fbinf fbinf
       left join pbcrs_report_receiveFile receivefile
       on fbinf.receivefileseqno=receivefile.seqno

       left join pbcrs_report_ErrInf errinf
       on errinf.fbinfseqno=fbinf.fbinfseqno

       left join pbcrs_report_sendfile sendfile
       on fbinf.receivefilename = substr(sendfile.ENCFILENAME,0,length(sendfile.ENCFILENAME)-5)

       left join pbcrs_report_sendfile_rel sendfile_rel
       on sendfile.seqno = sendfile_rel.fileseqno
       and sendfile_rel.orderseqno = fbinf.errrecid

       where 1=1
       <include refid="sql_selectCont"></include>
       order by receivefile.createdate desc,rownum desc

       )info1 where ROWNUM &lt;=#{endindex}
       )where RN >#{startindex}

   </select>
  
   <sql id="sql_selectReceivefile">

    <if test="importDate and importDate!=''">
    	and to_char(IMPORTDATE,'yyyy-mm-dd')  = #{importDate}
    </if>
     <if test="reportFileName!=null and reportFileName!=''">
    	and substr(RECEIVEFILENAME, length(RECEIVEFILENAME) - 33, 34) like '%${reportFileName}%'
    </if>
   
  </sql>
  <select id="selectReveicePage" resultType="map" parameterType="map">
    select * from (
    select info1.*,ROWNUM RN from (
    	select 
    		seqno,
            to_char(to_date(substr(RECEIVEFILENAME,length(RECEIVEFILENAME)-19,8),'yyyymmdd'),'yyyy-mm-dd') REPORTDATE,
	        substr(RECEIVEFILENAME,length(RECEIVEFILENAME)-11,3) BUSSTYPE,
	        RECEIVEFILENAME,
	        RECEIVETXTFILENAME, 
	        SENDFILENAME, 
	        SUCCESSCOUNT,
	        FAILCOUNT,
            to_char(IMPORTDATE,'yyyy-mm-dd') IMPORTDATE,
            importtime,
	        RESULTERRORREASON,
	        VALIDATERESULT
   			 from PBCRS_REPORT_RECEIVEFILE	
   			 where 1=1	
   			 <include refid="sql_selectReceivefile"></include>
   			 order by IMPORTDATE desc,rownum 
    )info1 where ROWNUM &lt;#{endindex}
     	
	)where RN &gt;=#{startindex}
  </select>
  
  <select id="selectReveiceCount" resultType="int" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 17 14:38:02 CST 2019.
    -->
    select count(1) from (
   		 select SEQNO, substr(RECEIVEFILENAME,length(RECEIVEFILENAME)-33,34) RECEIVEFILENAME, RECEIVEFILEPATH, RECEIVETXTFILENAME, SENDFILENAME, 
   	 	MSGCODE, SUCCESSCOUNT, FAILCOUNT, CREATEDATE, to_char(IMPORTDATE,'yyyy-mm-dd') IMPORTDATE,RESULTERRORREASON,VALIDATERESULT
   		 from PBCRS_REPORT_RECEIVEFILE  
   		 where 1 = 1 
    	<include refid="sql_selectReceivefile"></include>
    ) A 
   		
  </select>
</mapper>